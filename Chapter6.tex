\chapter{IDEMIX Based Solution}
In this chapter we will provide a solution using IDEMIX based IMS. We will give more details about how this system can be implemented, and how will it behave for the end users.
\section{IDEMIX IMS}
As in previous case we can replace IMS with IDEMIX based IMS in our pseudonymous system. This system will take user credentials and then send an IDEMIX token to the bank. This IDEMIX token contains pseudonym as well as account ID and policy for the user. This IMS can be controlled by a separate identity inside the bank or by a 3rd party.
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{figures/IDEMIX}
	\caption{Pseudonym System with IDEMIX IMS}
	\label{fig:IDEMIX}
\end{figure}
\section{System Setup}
The system can be setup in 2 ways:
\begin{itemize}
	\item IMS controlled by a separate department at bank.\\
	In this case the bank separate the authentication and service part in 2 different departments internally. Authentication is controlled by IMS which holds the IDEMIX credentials for the user. Service department only gets the IDEMIX token from the authentication department.
	\item IMS controlled by a third party\\
	In this case the bank operates the service part while the authentication part is operated by a trusted third party.
\end{itemize}
In both cases, bank and IMS have to collaborate. Bank have to trust the IMS system that IDEMIX token sent by the the IMS system is correct.
\subsection{Changes on the Bank Side}
In this system, bank needs to behave as an IDEMIX issuer and verifier. It will issue IDEMIX credentials for the users and also will verify the tokens sent by the IMS system. 
\subsection{Information Stored at IMS}
IMS system will behave like user in the IDEMIX system. IMS needs following user information to be stored
\begin{itemize}
	\item User IDEMIX credential
\end{itemize}
Account ID and policy can be stored in encrypted form in the credential itself. This IDEMIX credential for a particular user can be setup in the beginning and then can be used later to create authentication tokens.
\subsection{Changes needed on the User Side}
On user side no changes are needed. User access the system like before. User doesn't need to install any special software or hardware on his side to access the bank services. 
\section{User Creation}
Following are the steps for creation of a new user account in OpenID based system
\begin{itemize}
	\item User goes to bank to open a new account.
	\item User provides his details.
	\item Bank creates user policy and send this information to the IMS system along with other user information as an IDEMIX credential.
	\item IMS system verifies the IDEMIX credential for the user and provides user with credentials to access his account.
	\item User then can login to his account using the credentials.
	\item In case of corporate users, if user is the administrator then he can add more users using a web interface at the bank directly and decide account policies for those users.
\end{itemize}
\section{User Authentication}
Authentication steps are as following in IDEMIX based system
\begin{itemize}
	\item User goes to login page
	\item User provides his username and password
	\item This is sent to IDEMIX IMS which then gets the saved user credential and creates a presentation token with a pseudonym for the bank
	\begin{itemize}
		\item Also for escrow purposes the real user identity is also encrypted in the token with the public keys of authorities
	\end{itemize}
	\item Bank receives this presentation token and gets the following information
	\begin{itemize}
		\item Pseudonym
		\item Account ID
		\item Policy
	\end{itemize}
	\item Bank adds this information in a temporary policy database
	\item Bank saves the token for future escrow purposes
	\item User can then access services from the bank using the pseudonym
	\item All user transactions are logged with the pseudonym
\end{itemize}
\section{ID Escrow}
Following are the steps for ID escrow in IDEMIX based system
\begin{itemize}
	\item Authorities come to the bank for transaction data and IDEMIX token.
	\item After verifying, bank gives the transaction data and corresponding IDEMIX token to the authorities.
	\item Authorities then using their key get the real identity of the user from the IDEMIX token.
\end{itemize}
\section{Analysis}
With the use of IDEMIX IMS we add a pseudonymous layer in the system. This provides us the necessary privacy. In order to do so, IDEMIX IMS just need to store the IDEMIX credential of the user. 

The provider doesn’t need to store any mapping database on his side. It is easier for bank to implement, as bank really doesn’t have to trust the IDEMIX IMS to store sensitive data.

In case there is a discrepancy, the authorities need to go only to the bank to get the transaction data as well as the mapping data from the IDEMIX tokens.
\section {IDEMIX implementation in the Real World}
Now we will try to fit this implementation in our system, which includes Nykredit as the Bank, Signicat as the 3rd party, DTU as corporate customer and other government institutions as authorities.
\subsection{Addition of the New User}
Addition of the new user can happen as following:
\begin{enumerate}
	\item DTU registers the new user with the Nykredit giving them the user details and policies that should apply to the particular user regarding the account. 
	\begin{enumerate}
		\item Nykredit registers this new user with his User ID with the IMS system
	\end{enumerate}
	\item Nykredit issue an IDEMIX policy credential for the given user to DTU. This credential contains the policy information and account information for the user.
	\item DTU then use this policy credential to register the new user with Signicat. 
	\begin{enumerate}
		\item Signicat inquire about the user data with the authorities
		\item Authorities verify the user data to Signicat
	\end{enumerate}
	\item After that Signicat issue final IDEMIX credential for the IMS system. This credential is then used to create pseudonym IDEMIX tokens for the user. 
\end{enumerate}
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{figures/IDEMIX-Real}
	\caption{IDEMIX Registration for a new user}
	\label{fig:IDEMIX-Real}
\end{figure}
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{figures/Final}
	\caption{Final IDEMIX Credential from Policy Credential}
	\label{fig:Final}
\end{figure}
\FloatBarrier
\subsection{Addition of a New Customer}
Addition of the new customer is almost same as addition of new user:
\begin{enumerate}
	\item An administrator goes to Nykredit to open a bank account on behalf of DTU 
	\begin{enumerate}
		\item Nykredit registers DTU as new customer in their internal system.
		\item Nykredit registers the DTU administrator with his User ID with the IMS system
	\end{enumerate}
	\item Nykredit issue an IDEMIX policy credential for the  DTU administrator to himself. This credential contains the policy information and account information for the administrator.
	\item Administrator then use this policy credential to register himslef as owner of the new DTU account with Signicat. 
	\begin{enumerate}
		\item Signicat inquires about the data given in the credential with the authorities
		\item Authorities verify the data to Signicat
	\end{enumerate}
	\item After that Signicat issue final IDEMIX credential for the IMS system. This credential is then used to create pseudonym IDEMIX tokens for the administrator. 
\end{enumerate}
\subsection{Technical Requirements}
In this system DTU as a client does not need to change anything on their side to be a customer at Nykredit. All the system for DTU is web based where they can just add/remove users and also DTU users login to the system using the browser.

Nykredit have to implement IDEMIX issuer service on their side to issue IDEMIX Policy credential. This is done so that Nykredit doesn’t have to store the sensitive data at the 3rd party. Use of this credential ensures that this data remains safe. Nykredit also have to implement IDEMIX verifier service to verify the user identity.

Signicat have to implement IDEMIX issuer service also to issue final IDEMIX credentials.

IMS have to implement IDEMIX user service to create the IDEMIX tokens for the user while user is logging in.
\section{High Level Protocol Description}
In this section, we will give protocol description of the IDEMIX based system. This is a high level description of the protocol and full details can be found in \cite{camenisch2001efficient}.

We assume that all the systems are secured and all the communication within them is encrypted. Let $Cred_{I,U}(data1,data2,...)$ be an IDEMIX credential issued by issuer I to user U. We define DTU employee as entity D, Nykredit as entity N, IMS as entity I, Signicat as entity S and authorities as entity A. Also the notation
\begin{center}
$A->B : \{m\}$
\end{center}
means that a message $m$ is sent from $A$ to $B$ in encrypted form such that only A and B can read it.
We take 3 cases:

\begin{enumerate}
\item User Registration
\item User Authentication
\item User transaction
\end{enumerate}
	
\subsection{User Registration}
The first part of protocol is the user registration. It involves all the parties in the system. The details of the protocol are as below:
\begin{enumerate} 
\item 	Let  $username$ be the login name of the new user that DTU wants to give access to their account, $account\_id$ be the account number of DTU account with Nykredit and $policy_D$ be the policy defined by the DTU for the user on their account. DTU sends this information to the bank for the user registration.

\begin{center}
	$D -> N : \{username,account\_id,policy_D\}$
\end{center}
\begin{enumerate}
	\item Bank registers this new user with the IMS system with the given username and receives the password for user to login to the system.
	\begin{center}
		$N -> I : \{username\}$
		
		$I -> N : \{username,password\}$
		
	\end{center}	
\end{enumerate}
\item DTU sends this password as well as an IDEMIX credential for the given username back to DTU.
	\begin{center}
		$N -> D : \{username,password,Cred_N(username,account\_id,policy_N)\}$
	\end{center}	
Where $policy_N$ is the policy created by Nykredit for the user for the given account. It is a mix of the policy given ty the DTU and also some internal Bank policies. $Cred_N(username,account\_id,policy_N)$ is the IDEMIX credential issued by Nykredit for the user with given username.
\item DTU sends the user data and credential given by Nykredit to Signicat. This user data may contain \textit{real name,CPR nr,address,contact information} etc. for the user. 
\begin{center}
	$D -> S : \{username,userdata,Cred_N(username,account\_id,policy_N)\}$
\end{center}
\item Signicat verifies the user data with the authorities and then issue its own credential $Cred_S(userdata,Cred_N(account\_id,policy_N))$ for the user. This credential contains data from the Nykredit credential $Cred_N(account\_id,policy_N))$ also. This makes sure that Signicat is able to issue the credential over parameters given by Nykredit credential but have no access to the data inside.

Signicat sends this data to IMS system and user is registered with his credential in the IMS system.
\begin{center}
	$S -> I : \{username,Cred_S(userdata,Cred_N(account\_id,policy_N))\}$
\end{center}
User can now login to the system with IMS using his username and password.
\end{enumerate}

\subsection{User Authentication}
For user authentication, oly DTU employee, IMS and Nykredit systems are needed. The protocol works as follows:
\begin{enumerate}
	\item User sends his username and password to the IMS system.
	\begin{center}
		$D -> I : \{username,password\}$
	\end{center}
	\begin{enumerate}
	\item IMS system after verifying the user credentials, creates an IDEMIX token from the user credential.
	\begin{center}
		$Cred_S(userdata,Cred_N(account\_id,policy_N)) -> Token_I(pseudonym,account\_id,policy_N,\{userdata\}PK_A)$
	\end{center}
	$pseudonym$ is the pseudonym generated by the IMS for the user. $Token_I(pseudonym,account\_id,policy_N,\{userdata\}PK_A)$ is the IDEMIX token created by IMS from $Cred_S(userdata,Cred_N(account\_id,policy_N))$. $PK_A$ is the public key of authorities and $userdata$ is encrypted using this public key. It is a verifiable encryption and it can be verified that the token has actual $userdata$ encrypted using $PK_A$.
	\end{enumerate}
	\item IMS system then sends the IDEMIX token to Nykredit. 
	\begin{center}
		$I -> N : Token_I(account\_id,policy_N,\{userdata\}PK_A)$
	\end{center}
	\item Nykredit verifies the token and authenticates the user.
	\begin{center}
		$N -> D : {pseudonym,session_secret,status}$
	\end{center}
	Where $session_secret$ is the secret value that Nykredit established with the user. This value is sent in subsequent requests by the user to Nykredit.
\end{enumerate}
\subsection{User Transcation}
The user transaction happens in the same manner the current system. We assume that user is already authenticated using the steps above. The only entities involved are DTU and Nykredit in this case:
\begin{enumerate}
\item DTU user sends the transaction request to Nykredit.
	\begin{center}
		$D -> N : {session_secret,transaction_request}$
	\end{center}
\item Nykredit performs the transcation and sends the result back.
	\begin{center}
		$N -> D : {transaction_request,status}$
	\end{center}
\end{enumerate}


This chapter described the IMS system setup using the IDEMIX system. We described how the system would be setup and how it would affect all the parties involved. The API for the IDEMIX services can be found in \textit{Appendix A}.


